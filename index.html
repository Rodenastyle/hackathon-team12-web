<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <title>HackaTrips</title>
        
        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <!-- Theme CSS -->
        <link href="css/freelancer.min.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

        <!-- jQuery -->
        <script src="vendor/jquery/jquery.min.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
        <link href="vendor/bootstrap-select/css/bootstrap-select.min.css" rel="stylesheet" type="text/css">
        <link href="vendor/bootstrap-slider/css/bootstrap-slider.min.css" rel="stylesheet" type="text/css">
        <script src="vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
        <script src="vendor/bootstrap-slider/js/bootstrap-slider.min.js"></script>

        <!-- Plugin JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

        <!-- Theme JavaScript -->
        <script src="js/freelancer.min.js"></script>

        <!-- Angular -->
        <script src="js/angular/angular.min.js"></script>
        <script src="js/angular/angular-locale_es-es.js"></script>
        <script src="js/angular/angular-strap.min.js"></script>
        <script src="js/angular/angular-strap.tpl.js"></script>
        <script src="js/angular/controller.js"></script>    

        <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
        
        <style>
      
       
        </style>
        
    </head>
    
    <body id="page-top" class="index" ng-app="mgcrea.ngStrapDocs" ng-controller="controlador">

    <!-- Navigation -->
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top navbar-custom">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <img src="img/logo3.png" style="height: 80px;margin-top: -20px;margin-bottom: -20px;" alt="">
            </div>
            

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" >
                <div class="nav navbar-nav navbar-right" style="color:black;">
                    <select data-live-search="true" class="selectpicker" id="provincia">
                        <option selected value=''>En toda Espa&ntilde;a</option>
                        <option value='Araba/Álava'>&Aacute;lava</option>
                        <option value='Albacete'>Albacete</option>
                        <option value='Alicante/Alacant'>Alicante</option>
                        <option value='Almería'>Almer&iacute;a</option>
                        <option value='Asturias'>Asturias</option>
                        <option value='Ávila'>&Aacute;vila</option>
                        <option value='Badajoz'>Badajoz</option>
                        <option value='Balears, Illes'>Baleares</option>
                        <option value='Barcelona'>Barcelona</option>
                        <option value='Burgos'>Burgos</option>
                        <option value='Cáceres'>C&aacute;ceres</option>
                        <option value='Cádiz'>C&aacute;diz</option>
                        <option value='Cantabria'>Cantabria</option>
                        <option value='canarias'>Canarias</option>
                        <option value='Castellón/Castelló'>Castell&oacute;n</option>
                        <option value='Ciudad Real'>Ciudad Real</option>
                        <option value='Córdoba'>C&oacute;rdoba</option>
                        <option value='Cuenca'>Cuenca</option>
                        <option value='Girona'>Girona</option>
                        <option value='Granada'>Granada</option>
                        <option value='Guadalajara'>Guadalajara</option>
                        <option value='guipuzcoa'>Guip&uacute;zcoa</option>
                        <option value='Huelva'>Huelva</option>
                        <option value='Huesca'>Huesca</option>
                        <option value='Jaén'>Ja&eacute;n</option>
                        <option value='Rioja, La'>La Rioja</option>
                        <option value='Palmas, Las'>Las Palmas</option>
                        <option value='León'>Le&oacute;n</option>
                        <option value='Lleida'>Lleida</option>
                        <option value='Lugo'>Lugo</option>
                        <option value='Madrid'>Madrid</option>
                        <option value='Málaga'>M&aacute;laga</option>
                        <option value='Murcia'>Murcia</option>
                        <option value='Navarra'>Navarra</option>
                        <option value='Ourense'>Ourense</option>
                        <option value='Palencia'>Palencia</option>
                        <option value='Pontevedra'>Pontevedra</option>
                        <option value='Salamanca'>Salamanca</option>
                        <option value='Segovia'>Segovia</option>
                        <option value='Sevilla'>Sevilla</option>
                        <option value='Soria'>Soria</option>
                        <option value='Tarragona'>Tarragona</option>
                        <option value='Teruel'>Teruel</option>
                        <option value='Toledo'>Toledo</option>
                        <option value='Valencia/València'>Valencia</option>
                        <option value='Valladolid'>Valladolid</option>
                        <option value='Bizcaia'>Vizcaya</option>
                        <option value='Zamora'>Zamora</option>
                        <option value='Zaragoza'>Zaragoza</option>
                    </select>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>
        <div class="col-lg-12" style="height: 550px; padding-top: 650px;" id="map">
        </div>
    </header>

    <!-- Portfolio Grid Section -->
    <section id="portfolio" style="display:none;">
        <div class="container">
            <div class="row" style="margin-top:40px;">
                <div class="col-lg-12 text-center">
                    <h2>Municipios</h2>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="row" id="plantilla">
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="text-center">
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Equipo 12 - HackaTrips - Fitur
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Portfolio Modals -->
    <div class="portfolio-modal modal fade" id="portfolioModal1" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <h2 id="nombreHotel"></h2>
                            <hr class="star-primary">
                            <img src="" id="imgHotel" class="img-responsive img-centered" alt="">
                            <h4 id="poblacion" style="margin-bottom: 20px;"></h4>
                        </div>
                    </div>
                </div>
                <span id="ex18-label-2a" class="hidden">KM</span>
                <span id="ex18-label-2b" class="hidden">KM</span>
                <input id="ex18b" type="text"/>
                <section>
                    <div class="container">
                        <div class="row" style="margin-top:-80px;">
                            <div class="col-lg-12 text-center">
                                <h2>Puntos de Interés Turístico</h2>
                                <hr class="star-primary">
                            </div>
                        </div>
                        <div class="row" id="pois">
                        </div>
                    </div>
                </section>
                <section>
                    <div class="container">
                        <div class="row" style="margin-top:-80px;">
                            <div class="col-lg-12 text-center">
                                <h2>Hoteles</h2>
                                <hr class="star-primary">
                            </div>
                        </div>
                        <div class="row" id="hoteles">
                        </div>
                    </div>
                </section>
                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
            </div>
        </div>
    </div>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>     
    
    <script>
    var sublayer0;
    var map;
    var layer;
    var sql;
      function main() {
        map = L.map('map', { 
          zoomControl: false,
          center: [40.418709, -3.703277],
          zoom: 6
        });
        // add a nice baselayer from Stamen 
        L.tileLayer('http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.png', {
          attribution: 'Stamen and CartoDB attribution'
        }).addTo(map);
         cartodb.createLayer(map, {
          user_name: 'hackatrips05',
          type: 'cartodb',
          sublayers: [{
             sql: "SELECT * FROM hackatrips05.popclean4",
             cartocss: '/** bubble visualization */ #layer {  marker-width: 7;  marker-fill: #FFB927;  marker-fill-opacity: 0.9;  marker-allow-overlap: true;  marker-line-width: 1;  marker-line-color: #FFF;  marker-line-opacity: 1;}',
             interactivity: 'cartodb_id,provincia, municipio'
          }]   
        },{https:true})
         .addTo(map)
         .on('done', function(layer) {
            sublayer0 = layer.getSubLayer(0);
            /*cdb.vis.Vis.addInfowindow(map, sublayer0, 
            ['cartodb_id','provincia' , 'municipio'],
            {infowindowTemplate: $('#infowindow_template').html()});*/
            sublayer0.setInteraction(true);
            sublayer0.on('featureClick', function(event, latlng, pos, data){
                loadPuebloCarto(data.cartodb_id);
                console.log(data);
            });
        });
        }

        $("select" ).on('change', function(e) {
            if(this.value=="")
                sql = "SELECT * FROM hackatrips05.popclean4";
            else
                sql = "SELECT * FROM hackatrips05.popclean4 WHERE provincia='"+this.value+"'";
            changeSql(sql);
            loadPueblos(this.value, 1, '');
        });

        function mostrarPueblos(result){
            var html = "";
            $.each( result, function( key, value ) {
                if(value['image_url'] == 'default' || value['image_url'] == '')
                    value['image_url'] = 'img/portfolio/cabin.png';
                html = html+'<div class="col-sm-4 portfolio-item"><a onClick="loadPueblo('+value['id']+')" class="portfolio-link" data-toggle="modal"><div class="caption"><div class="caption-content"><i class="fa fa-search-plus fa-3x"></i></div></div><div style="text-align: center; font-size: 25px; background-color: #FFF">'+value['name']+'</div><img src="'+value['image_url']+'" class="img-responsive"     style="height:260; width:360;"alt=""></a></div>';
            });
            $("#plantilla").html(html);
            $("#portfolio").show();               
        }
/*
        function mostrarPueblo(result){
            console.log(result);
            var html = "";
            if(value['image_url'] == 'default')
                value['image_url'] = 'img/portfolio/cabin.png';
            html = '<div class="col-sm-4 portfolio-item"><a onClick="abrirModal('+result['id']+')" class="portfolio-link" data-toggle="modal"><div class="caption"><div class="caption-content"><i class="fa fa-search-plus fa-3x"></i></div></div><div style="text-align: center; font-size: 25px; background-color: #FFF">'+result['name']+'</div><img src="'+result['image_url']+'" class="img-responsive"     style="height:260; width:360;"alt=""></a></div>';
            $("#plantilla").html(html);
            $("#portfolio").show();    
            alert(html);           
        }
*/
        function changeSql(sql){
            sublayer0.setSQL(sql);
            var sql2 = new cartodb.SQL({ user: 'hackatrips05' });
                sql2.getBounds(sql).done(function(bounds) {
                map.fitBounds(bounds);
            });
        }   

        function abrirModal(data){
            if(data['image_url'] == 'default' || data['image_url'] == '')
                data['image_url'] = 'img/portfolio/cabin.png';
            $("#nombreHotel").text(data['name']);
            $("#poblacion").text("Número de habitantes: "+data['population']);
            $("#imgHotel").attr("src",data['image_url']);
            $("#portfolioModal1").modal("show");
            
            mostrarPOIS(data['pois']);
            mostrarHoteles(data['hotels']);
        }    

        function mostrarPOIS(data){
            var html = "";
            $.each( data, function( key, value ) {
                if(value['picture_url'] == "default" || value['picture_url'] == ""){
                    value['picture_url'] = 'img/portfolio/cabin.png';
                }
                html = html+'<div class="col-sm-4 portfolio-item" style="margin-bottom:35px;"><div style="text-align: center; font-size: 25px; background-color: #FFF">'+value['name']+'</div><img src='+value['picture_url']+'  style="height:260; width:360;" class="img-responsive" alt="" style="margin-bottom: 0px;"></div>';
            });
            $("#pois").html(html);
        }

        function mostrarHoteles(data){
            console.log(data);
            var html = "";
            $.each( data, function( key, value ) {
                if(value['rooms'][0]['rates'][0]['sellingRate'] != null){
                    html = html+'<div onClick="reservar()" class="col-sm-4 portfolio-item" style="margin-bottom:35px;"><div style="text-align: center; font-size: 25px; background-color: #FFF">'+value['name']+'</div><img src="img/hotel.jpg" class="img-responsive" alt="" style="margin-bottom: 0px;"><div style="text-align: center; font-size: 25px; color: #000000">Precio: '+value['rooms'][0]['rates'][0]['sellingRate']+' € - Reservar</div></div>';
                }
            });
            $("#hoteles").html(html);

        }

        function reservar(){
            alert("Reserva Realizada!! Disfruta del viaje! ;-)");
        }

        $("#ex18a").slider({
            min: 0,
            max: 250,
            value: 5,
            labelledby: 'ex18-label-1'
        });
        $("#ex18b").slider({
            min: 0,
            max: 250,
            value: [0, 25],
            tooltip: 'always',
            labelledby: ['ex18-label-2a', 'ex18-label-2b']
        });

        function loadPueblos(provincia, action, ciudad){   
            if(provincia != ""){
                $.ajax({
                    type: "GET",
                    url: 'http://api.conpocomelomonto.com/api/provinces/'+provincia+'/towns',
                    dataType: 'json',
                    beforeSend: setHeader,
                    success: function(data){
                        if(action==1){
                            mostrarPueblos(data);
                        }else if(action==2){
                            $.each( data, function( key, value ) {
                                console.log(value);
                                if(value['municipio'] == ciudad){
                                    mostrarPueblo(value[key]);
                                    alert('Dentro');
                                }
                            });
                            
                        }
                    }
                });
            }else{
                $("#portfolio").hide();   
            }
        }

        function loadPueblo(id){   
            $.ajax({
                type: "GET",
                //url: 'http://api.conpocomelomonto.com/api/towns/carto/'+id,
                url: 'http://api.conpocomelomonto.com/api/towns/'+id,
                dataType: 'json',
                beforeSend: setHeader,
                success: function(data){
                   abrirModal(data);
                   
                }
            });
        }

        function loadPuebloCarto(id){   
            $.ajax({
                type: "GET",
                url: 'http://api.conpocomelomonto.com/api/towns/carto/'+id,
                //url: 'http://api.conpocomelomonto.com/api/towns/'+id,
                dataType: 'json',
                beforeSend: setHeader,
                success: function(data){
                   abrirModal(data);
                   
                }
            });
        }

        function setHeader(xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjJhYTlkMGRjNDJjNzk0ZjdhOGYwMGE4MzdkZTE3NzBmMjhiZGZhMDBlMzhiYmE3Njc1MjUxOGY2NzE2YzIzYWQ4OGE5N2JlZDZkOGJlNjE4In0.eyJhdWQiOiIxIiwianRpIjoiMmFhOWQwZGM0MmM3OTRmN2E4ZjAwYTgzN2RlMTc3MGYyOGJkZmEwMGUzOGJiYTc2NzUyNTE4ZjY3MTZjMjNhZDg4YTk3YmVkNmQ4YmU2MTgiLCJpYXQiOjE0ODUwNzg1ODYsIm5iZiI6MTQ4NTA3ODU4NiwiZXhwIjoxODAwNjExMzg2LCJzdWIiOiIxIiwic2NvcGVzIjpbXX0.HkVUXSvq9fwJci3AJTJlFJyCFBZtGMa-XAUVMFf5exBQWHC56gV9m1qN1DR-8yUbPFkOiRH2jAIJLTEHKch2IOXVw2cjLKHMrAj62N21bxJ-pQ3fLEX5bKgiZg672yC1NyojJGmucmxKt_73-HIWncl_1t0Fr921Zc0LbUsjUxyEVDipVzRvZsKU4UOxxPXS7c_3eYoXjE8btRQBAHcMhLTJeVgt8O_nV8s3L0QEd6jYl61YgABJnZKjtunRnOYVTQIRkA03hvVQXmGpkBG4dL06uRmDUI1uT8iXFQVl9SCjFUmQ3gWpbfY-sTpUKQ5o3wDByHfGLrxGUkZB2_Opd5c3ZwmfodAVjovkc1m6qcYGbnL68NztLM1xeB1iLiXMP89sgdhdrvEWh3F4x_JCV1R5lBzhrPfTcwxUSphj7CW0XwSQCQfxHnqKExtfy8oWzcavhtRKIZYZWd5GU-xMK8iVpfpe77lkEkOY0WfaYPsMPUWqWqY2Bi-gEHyN2OLdr36iO9GVRCYq--bOpl71EQKH0epGxy6xGT_rNYbAfdNiiPtmp7CuQQKFHqopGJIObyPemGJ6AYaNRUiQqlyfV3CATPGevewmgxjQz-FIZsjLBcc8u6TZQMcXQz3kJe-A0ErAVK1pXmnAQlQFUZykEGAllIDuErRC7bQN4c9m6hA');
        }    

        window.onload = main; 
    </script>

    <script type="infowindow/html" id="infowindow_template">
        <div class="infowindow-custom">
          <a href="#close" class="cartodb-popup-close-button close">x</a>
           <div class="cartodb-popup-content">
            <div class="content" style="padding:20px">
              <h3>Country:</h3> aaaaa
              <p>{{content.data.adm0name}}</p>
              <h3>City:</h3>
              <p>{{content.data.name}}</p>
              <h3>Max population:</h3>
              <p>{{content.data.pop_max}}</p>
              <div>
          <div>
          <div class="cartodb-popup-tip-container"></div>
        </div>
    </script>
       
    </body>
</html>